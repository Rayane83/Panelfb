{% extends "base.html" %}

{% block title %}SuperAdmin - FlashbackFA Enterprise{% endblock %}

{% block content %}
<div class="space-y-6">
    <div class="flex items-center justify-between">
        <div>
            <h2 class="text-3xl font-bold tracking-tight">Administration SuperAdmin</h2>
            <p class="text-gray-600">Panel de contrôle complet - Gestion des entreprises et grilles fiscales</p>
        </div>
        <button onclick="location.reload()" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 flex items-center space-x-2">
            <i data-lucide="refresh-cw" class="h-4 w-4"></i>
            <span>Actualiser</span>
        </button>
    </div>

    <!-- Onglets -->
    <div class="border-b border-gray-200">
        <nav class="-mb-px flex space-x-8">
            <button onclick="showTab('enterprises')" class="tab-button active" data-tab="enterprises">
                <i data-lucide="building" class="h-4 w-4 mr-2"></i>
                Entreprises
            </button>
            <button onclick="showTab('tax-brackets')" class="tab-button" data-tab="tax-brackets">
                <i data-lucide="calculator" class="h-4 w-4 mr-2"></i>
                Tranches Fiscales
            </button>
            <button onclick="showTab('system')" class="tab-button" data-tab="system">
                <i data-lucide="settings" class="h-4 w-4 mr-2"></i>
                Système
            </button>
        </nav>
    </div>

    <!-- Contenu des onglets -->
    <div id="tab-enterprises" class="tab-content">
        <!-- Statistiques -->
        <div class="grid gap-4 md:grid-cols-4 mb-6">
            <div class="card">
                <div class="flex items-center justify-between mb-2">
                    <h4 class="text-sm font-medium text-gray-600">Entreprises</h4>
                    <i data-lucide="building" class="h-4 w-4 text-gray-400"></i>
                </div>
                <div class="text-2xl font-bold">{{ enterprises|length }}</div>
                <p class="text-xs text-gray-500">Total créées</p>
            </div>

            <div class="card">
                <div class="flex items-center justify-between mb-2">
                    <h4 class="text-sm font-medium text-gray-600">Blanchiment Actif</h4>
                    <i data-lucide="shield" class="h-4 w-4 text-green-600"></i>
                </div>
                <div class="text-2xl font-bold text-green-600">
                    {{ enterprises|selectattr('settings.blanchiment_enabled')|list|length }}
                </div>
                <p class="text-xs text-gray-500">Entreprises autorisées</p>
            </div>

            <div class="card">
                <div class="flex items-center justify-between mb-2">
                    <h4 class="text-sm font-medium text-gray-600">Tranches IS</h4>
                    <i data-lucide="calculator" class="h-4 w-4 text-gray-400"></i>
                </div>
                <div class="text-2xl font-bold">{{ tax_brackets|length }}</div>
                <p class="text-xs text-gray-500">Configurées</p>
            </div>

            <div class="card">
                <div class="flex items-center justify-between mb-2">
                    <h4 class="text-sm font-medium text-gray-600">Tranches Richesse</h4>
                    <i data-lucide="dollar-sign" class="h-4 w-4 text-gray-400"></i>
                </div>
                <div class="text-2xl font-bold">{{ wealth_brackets|length }}</div>
                <p class="text-xs text-gray-500">Configurées</p>
            </div>
        </div>

        <!-- Création d'entreprise -->
        <div class="card">
            <h3 class="text-lg font-semibold mb-4 flex items-center space-x-2">
                <i data-lucide="plus" class="h-5 w-5"></i>
                <span>Créer une nouvelle entreprise</span>
            </h3>
            <p class="text-sm text-gray-600 mb-6">Tous les champs marqués d'un * sont obligatoires</p>
            
            <form id="create-enterprise-form" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="space-y-2">
                        <label class="block text-sm font-medium">Nom de l'entreprise *</label>
                        <input type="text" name="name" class="input" placeholder="Mon Entreprise" required>
                    </div>
                    <div class="space-y-2">
                        <label class="block text-sm font-medium">Guild ID Discord *</label>
                        <input type="text" name="guild_id" class="input" placeholder="123456789012345678" required>
                    </div>
                    <div class="space-y-2">
                        <label class="block text-sm font-medium">Type d'entreprise</label>
                        <select name="type" class="input">
                            <option value="SARL">SARL</option>
                            <option value="SAS">SAS</option>
                            <option value="SA">SA</option>
                            <option value="EURL">EURL</option>
                            <option value="Auto-entrepreneur">Auto-entrepreneur</option>
                        </select>
                    </div>
                    <div class="space-y-2">
                        <label class="block text-sm font-medium">Owner Discord ID *</label>
                        <input type="text" name="owner_discord_id" class="input" placeholder="123456789012345678" required>
                    </div>
                </div>
                <div class="space-y-2">
                    <label class="block text-sm font-medium">Description</label>
                    <textarea name="description" class="input min-h-20" placeholder="Description de l'entreprise..."></textarea>
                </div>
                <button type="submit" class="btn-primary w-full">
                    <i data-lucide="plus" class="h-4 w-4 mr-2"></i>
                    Créer l'entreprise
                </button>
            </form>
        </div>

        <!-- Liste des entreprises -->
        <div class="card">
            <h3 class="text-lg font-semibold mb-4">Entreprises existantes ({{ enterprises|length }})</h3>
            <div class="space-y-4">
                {% for enterprise in enterprises %}
                <div class="flex items-center justify-between p-4 border rounded-lg hover:shadow-md transition-shadow">
                    <div class="space-y-2">
                        <div class="flex items-center space-x-2">
                            <p class="font-medium">{{ enterprise.name }}</p>
                            {% if enterprise.settings and enterprise.settings.blanchiment_enabled %}
                            <span class="badge badge-success">Blanchiment OK</span>
                            {% endif %}
                            <span class="badge border border-gray-300 text-gray-700">{{ enterprise.type }}</span>
                        </div>
                        <div class="text-sm text-gray-500 space-y-1">
                            <p>Guild: {{ enterprise.guild_id }}</p>
                            <p>Owner: {{ enterprise.owner_discord_id }}</p>
                            {% if enterprise.description %}
                            <p>Description: {{ enterprise.description }}</p>
                            {% endif %}
                            <p>Créée le: {{ enterprise.created_at|date_fr }}</p>
                        </div>
                    </div>
                    <button onclick="deleteEnterprise('{{ enterprise.id }}')" 
                            class="px-3 py-2 border border-red-300 text-red-600 rounded-lg hover:bg-red-50">
                        <i data-lucide="trash-2" class="h-4 w-4"></i>
                    </button>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <div id="tab-tax-brackets" class="tab-content hidden">
        <div class="grid gap-6 md:grid-cols-2">
            <!-- Tranches IS -->
            <div class="card">
                <h3 class="text-lg font-semibold mb-4">Tranches Impôt sur les Sociétés</h3>
                <div class="space-y-3">
                    {% for bracket in tax_brackets %}
                    <div class="flex justify-between items-center p-3 border rounded">
                        <div>
                            <p class="text-sm font-medium">
                                {{ bracket.min_amount|currency }} - 
                                {% if bracket.max_amount %}{{ bracket.max_amount|currency }}{% else %}∞{% endif %}
                            </p>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="badge badge-info">{{ bracket.rate }}%</span>
                            <button onclick="deleteTaxBracket('{{ bracket.id }}')" class="text-red-600 hover:text-red-700">
                                <i data-lucide="trash-2" class="h-4 w-4"></i>
                            </button>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Tranches richesse -->
            <div class="card">
                <h3 class="text-lg font-semibold mb-4">Tranches Impôt sur la Richesse</h3>
                <div class="space-y-3">
                    {% for bracket in wealth_brackets %}
                    <div class="flex justify-between items-center p-3 border rounded">
                        <div>
                            <p class="text-sm font-medium">
                                {{ bracket.min_amount|currency }} - 
                                {% if bracket.max_amount %}{{ bracket.max_amount|currency }}{% else %}∞{% endif %}
                            </p>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="badge bg-purple-100 text-purple-800">{{ bracket.rate }}%</span>
                            <button onclick="deleteTaxBracket('{{ bracket.id }}')" class="text-red-600 hover:text-red-700">
                                <i data-lucide="trash-2" class="h-4 w-4"></i>
                            </button>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <div id="tab-system" class="tab-content hidden">
        <div class="card">
            <h3 class="text-lg font-semibold mb-4">Informations Système</h3>
            <div class="grid gap-4 md:grid-cols-2">
                <div class="space-y-2">
                    <label class="block text-sm font-medium">Guilde Principale</label>
                    <input type="text" class="input bg-gray-100" value="{{ config.MAIN_GUILD_ID or 'Non configuré' }}" readonly>
                </div>
                <div class="space-y-2">
                    <label class="block text-sm font-medium">Guilde DOT</label>
                    <input type="text" class="input bg-gray-100" value="{{ config.DOT_GUILD_ID or 'Non configuré' }}" readonly>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function showTab(tabName) {
        // Cacher tous les onglets
        document.querySelectorAll('.tab-content').forEach(tab => {
            tab.classList.add('hidden');
        });
        
        // Désactiver tous les boutons d'onglet
        document.querySelectorAll('.tab-button').forEach(button => {
            button.classList.remove('active');
        });
        
        // Afficher l'onglet sélectionné
        document.getElementById(`tab-${tabName}`).classList.remove('hidden');
        document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
    }

    async function createEnterprise(event) {
        event.preventDefault();
        
        const formData = new FormData(event.target);
        const data = Object.fromEntries(formData.entries());
        
        try {
            const response = await apiCall('/api/enterprises', 'POST', data);
            
            if (response.success) {
                showToast('success', 'Entreprise créée avec succès');
                location.reload();
            } else {
                showToast('error', 'Erreur lors de la création');
            }
        } catch (error) {
            console.error('Error:', error);
            showToast('error', 'Erreur lors de la création');
        }
    }

    function deleteEnterprise(enterpriseId) {
        if (confirm('Êtes-vous sûr de vouloir supprimer cette entreprise ?')) {
            // Logique de suppression
            showToast('success', 'Entreprise supprimée');
        }
    }

    function deleteTaxBracket(bracketId) {
        if (confirm('Êtes-vous sûr de vouloir supprimer cette tranche ?')) {
            // Logique de suppression
            showToast('success', 'Tranche fiscale supprimée');
        }
    }

    function showToast(type, message) {
        const toast = document.createElement('div');
        toast.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 fade-in ${
            type === 'success' ? 'bg-green-100 text-green-800 border border-green-200' :
            'bg-red-100 text-red-800 border border-red-200'
        }`;
        toast.innerHTML = `
            <div class="flex items-center space-x-2">
                <i data-lucide="${type === 'success' ? 'check-circle' : 'alert-triangle'}" class="h-4 w-4"></i>
                <span>${message}</span>
            </div>
        `;
        document.body.appendChild(toast);
        lucide.createIcons();
        
        setTimeout(() => {
            toast.style.opacity = '0';
            toast.style.transform = 'translateX(100%)';
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }

    // Initialisation
    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('create-enterprise-form').addEventListener('submit', createEnterprise);
    });
</script>

<style>
    .tab-button {
        padding: 0.75rem 1rem;
        border-bottom: 2px solid transparent;
        color: #6b7280;
        font-medium: 500;
        transition: all 0.2s;
        display: flex;
        align-items: center;
    }
    
    .tab-button:hover {
        color: #3b82f6;
        border-bottom-color: #3b82f6;
    }
    
    .tab-button.active {
        color: #3b82f6;
        border-bottom-color: #3b82f6;
    }
</style>
{% endblock %}